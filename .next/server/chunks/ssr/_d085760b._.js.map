{"version":3,"sources":["../../../../node_modules/date-fns/startOfMonth.js","../../../../node_modules/date-fns/endOfMonth.js","../../../../node_modules/date-fns/addMonths.js","../../../../node_modules/date-fns/subMonths.js","../../../../src/lib/time-series.ts","../../../../node_modules/date-fns/constants.js","../../../../node_modules/date-fns/constructFrom.js","../../../../node_modules/date-fns/toDate.js","../../../../node_modules/date-fns/addDays.js","../../../../node_modules/date-fns/subDays.js","../../../../node_modules/date-fns/startOfDay.js","../../../../node_modules/date-fns/_lib/getRoundingMethod.js","../../../../node_modules/date-fns/differenceInMinutes.js","../../../../node_modules/date-fns/differenceInMilliseconds.js","../../../../src/lib/cache-metrics.ts","../../../../src/app/%28dashboard%29/actions/sync-integrations.ts"],"sourcesContent":["import { toDate } from \"./toDate.js\";\n\n/**\n * The {@link startOfMonth} function options.\n */\n\n/**\n * @name startOfMonth\n * @category Month Helpers\n * @summary Return the start of a month for the given date.\n *\n * @description\n * Return the start of a month for the given date. The result will be in the local timezone.\n *\n * @typeParam DateType - The `Date` type, the function operates on. Gets inferred from passed arguments.\n * Allows to use extensions like [`UTCDate`](https://github.com/date-fns/utc).\n * @typeParam ResultDate - The result `Date` type, it is the type returned from the context function if it is passed,\n * or inferred from the arguments.\n *\n * @param date - The original date\n * @param options - An object with options\n *\n * @returns The start of a month\n *\n * @example\n * // The start of a month for 2 September 2014 11:55:00:\n * const result = startOfMonth(new Date(2014, 8, 2, 11, 55, 0))\n * //=> Mon Sep 01 2014 00:00:00\n */\nexport function startOfMonth(date, options) {\n  const _date = toDate(date, options?.in);\n  _date.setDate(1);\n  _date.setHours(0, 0, 0, 0);\n  return _date;\n}\n\n// Fallback for modularized imports:\nexport default startOfMonth;\n","import { toDate } from \"./toDate.js\";\n\n/**\n * The {@link endOfMonth} function options.\n */\n\n/**\n * @name endOfMonth\n * @category Month Helpers\n * @summary Return the end of a month for the given date.\n *\n * @description\n * Return the end of a month for the given date.\n * The result will be in the local timezone.\n *\n * @typeParam DateType - The `Date` type, the function operates on. Gets inferred from passed arguments. Allows to use extensions like [`UTCDate`](https://github.com/date-fns/utc).\n * @typeParam ResultDate - The result `Date` type, it is the type returned from the context function if it is passed, or inferred from the arguments.\n *\n * @param date - The original date\n * @param options - An object with options\n *\n * @returns The end of a month\n *\n * @example\n * // The end of a month for 2 September 2014 11:55:00:\n * const result = endOfMonth(new Date(2014, 8, 2, 11, 55, 0))\n * //=> Tue Sep 30 2014 23:59:59.999\n */\nexport function endOfMonth(date, options) {\n  const _date = toDate(date, options?.in);\n  const month = _date.getMonth();\n  _date.setFullYear(_date.getFullYear(), month + 1, 0);\n  _date.setHours(23, 59, 59, 999);\n  return _date;\n}\n\n// Fallback for modularized imports:\nexport default endOfMonth;\n","import { constructFrom } from \"./constructFrom.js\";\nimport { toDate } from \"./toDate.js\";\n\n/**\n * The {@link addMonths} function options.\n */\n\n/**\n * @name addMonths\n * @category Month Helpers\n * @summary Add the specified number of months to the given date.\n *\n * @description\n * Add the specified number of months to the given date.\n *\n * @typeParam DateType - The `Date` type, the function operates on. Gets inferred from passed arguments. Allows to use extensions like [`UTCDate`](https://github.com/date-fns/utc).\n * @typeParam ResultDate - The result `Date` type, it is the type returned from the context function if it is passed, or inferred from the arguments.\n *\n * @param date - The date to be changed\n * @param amount - The amount of months to be added.\n * @param options - The options object\n *\n * @returns The new date with the months added\n *\n * @example\n * // Add 5 months to 1 September 2014:\n * const result = addMonths(new Date(2014, 8, 1), 5)\n * //=> Sun Feb 01 2015 00:00:00\n *\n * // Add one month to 30 January 2023:\n * const result = addMonths(new Date(2023, 0, 30), 1)\n * //=> Tue Feb 28 2023 00:00:00\n */\nexport function addMonths(date, amount, options) {\n  const _date = toDate(date, options?.in);\n  if (isNaN(amount)) return constructFrom(options?.in || date, NaN);\n  if (!amount) {\n    // If 0 months, no-op to avoid changing times in the hour before end of DST\n    return _date;\n  }\n  const dayOfMonth = _date.getDate();\n\n  // The JS Date object supports date math by accepting out-of-bounds values for\n  // month, day, etc. For example, new Date(2020, 0, 0) returns 31 Dec 2019 and\n  // new Date(2020, 13, 1) returns 1 Feb 2021.  This is *almost* the behavior we\n  // want except that dates will wrap around the end of a month, meaning that\n  // new Date(2020, 13, 31) will return 3 Mar 2021 not 28 Feb 2021 as desired. So\n  // we'll default to the end of the desired month by adding 1 to the desired\n  // month and using a date of 0 to back up one day to the end of the desired\n  // month.\n  const endOfDesiredMonth = constructFrom(options?.in || date, _date.getTime());\n  endOfDesiredMonth.setMonth(_date.getMonth() + amount + 1, 0);\n  const daysInMonth = endOfDesiredMonth.getDate();\n  if (dayOfMonth >= daysInMonth) {\n    // If we're already at the end of the month, then this is the correct date\n    // and we're done.\n    return endOfDesiredMonth;\n  } else {\n    // Otherwise, we now know that setting the original day-of-month value won't\n    // cause an overflow, so set the desired day-of-month. Note that we can't\n    // just set the date of `endOfDesiredMonth` because that object may have had\n    // its time changed in the unusual case where where a DST transition was on\n    // the last day of the month and its local time was in the hour skipped or\n    // repeated next to a DST transition.  So we use `date` instead which is\n    // guaranteed to still have the original time.\n    _date.setFullYear(\n      endOfDesiredMonth.getFullYear(),\n      endOfDesiredMonth.getMonth(),\n      dayOfMonth,\n    );\n    return _date;\n  }\n}\n\n// Fallback for modularized imports:\nexport default addMonths;\n","import { addMonths } from \"./addMonths.js\";\n\n/**\n * The subMonths function options.\n */\n\n/**\n * @name subMonths\n * @category Month Helpers\n * @summary Subtract the specified number of months from the given date.\n *\n * @description\n * Subtract the specified number of months from the given date.\n *\n * @typeParam DateType - The `Date` type, the function operates on. Gets inferred from passed arguments. Allows to use extensions like [`UTCDate`](https://github.com/date-fns/utc).\n * @typeParam ResultDate - The result `Date` type, it is the type returned from the context function if it is passed, or inferred from the arguments.\n *\n * @param date - The date to be changed\n * @param amount - The amount of months to be subtracted.\n * @param options - An object with options\n *\n * @returns The new date with the months subtracted\n *\n * @example\n * // Subtract 5 months from 1 February 2015:\n * const result = subMonths(new Date(2015, 1, 1), 5)\n * //=> Mon Sep 01 2014 00:00:00\n */\nexport function subMonths(date, amount, options) {\n  return addMonths(date, -amount, options);\n}\n\n// Fallback for modularized imports:\nexport default subMonths;\n","import { format, startOfMonth, endOfMonth, subMonths } from 'date-fns';\r\n\r\nexport interface MonthlyBucket {\r\n  key: string;\r\n  label: string;\r\n  start: Date;\r\n  end: Date;\r\n}\r\n\r\nexport function getMonthlyBuckets(months = 12, anchor: Date = new Date()): MonthlyBucket[] {\r\n  const buckets: MonthlyBucket[] = [];\r\n  const anchorStart = startOfMonth(anchor);\r\n\r\n  for (let i = months - 1; i >= 0; i -= 1) {\r\n    const start = subMonths(anchorStart, i);\r\n    buckets.push({\r\n      key: format(start, 'yyyy-MM'),\r\n      label: format(start, 'MMM yy'),\r\n      start,\r\n      end: endOfMonth(start)\r\n    });\r\n  }\r\n\r\n  return buckets;\r\n}\r\n\r\n","/**\n * @module constants\n * @summary Useful constants\n * @description\n * Collection of useful date constants.\n *\n * The constants could be imported from `date-fns/constants`:\n *\n * ```ts\n * import { maxTime, minTime } from \"./constants/date-fns/constants\";\n *\n * function isAllowedTime(time) {\n *   return time <= maxTime && time >= minTime;\n * }\n * ```\n */\n\n/**\n * @constant\n * @name daysInWeek\n * @summary Days in 1 week.\n */\nexport const daysInWeek = 7;\n\n/**\n * @constant\n * @name daysInYear\n * @summary Days in 1 year.\n *\n * @description\n * How many days in a year.\n *\n * One years equals 365.2425 days according to the formula:\n *\n * > Leap year occurs every 4 years, except for years that are divisible by 100 and not divisible by 400.\n * > 1 mean year = (365+1/4-1/100+1/400) days = 365.2425 days\n */\nexport const daysInYear = 365.2425;\n\n/**\n * @constant\n * @name maxTime\n * @summary Maximum allowed time.\n *\n * @example\n * import { maxTime } from \"./constants/date-fns/constants\";\n *\n * const isValid = 8640000000000001 <= maxTime;\n * //=> false\n *\n * new Date(8640000000000001);\n * //=> Invalid Date\n */\nexport const maxTime = Math.pow(10, 8) * 24 * 60 * 60 * 1000;\n\n/**\n * @constant\n * @name minTime\n * @summary Minimum allowed time.\n *\n * @example\n * import { minTime } from \"./constants/date-fns/constants\";\n *\n * const isValid = -8640000000000001 >= minTime;\n * //=> false\n *\n * new Date(-8640000000000001)\n * //=> Invalid Date\n */\nexport const minTime = -maxTime;\n\n/**\n * @constant\n * @name millisecondsInWeek\n * @summary Milliseconds in 1 week.\n */\nexport const millisecondsInWeek = 604800000;\n\n/**\n * @constant\n * @name millisecondsInDay\n * @summary Milliseconds in 1 day.\n */\nexport const millisecondsInDay = 86400000;\n\n/**\n * @constant\n * @name millisecondsInMinute\n * @summary Milliseconds in 1 minute\n */\nexport const millisecondsInMinute = 60000;\n\n/**\n * @constant\n * @name millisecondsInHour\n * @summary Milliseconds in 1 hour\n */\nexport const millisecondsInHour = 3600000;\n\n/**\n * @constant\n * @name millisecondsInSecond\n * @summary Milliseconds in 1 second\n */\nexport const millisecondsInSecond = 1000;\n\n/**\n * @constant\n * @name minutesInYear\n * @summary Minutes in 1 year.\n */\nexport const minutesInYear = 525600;\n\n/**\n * @constant\n * @name minutesInMonth\n * @summary Minutes in 1 month.\n */\nexport const minutesInMonth = 43200;\n\n/**\n * @constant\n * @name minutesInDay\n * @summary Minutes in 1 day.\n */\nexport const minutesInDay = 1440;\n\n/**\n * @constant\n * @name minutesInHour\n * @summary Minutes in 1 hour.\n */\nexport const minutesInHour = 60;\n\n/**\n * @constant\n * @name monthsInQuarter\n * @summary Months in 1 quarter.\n */\nexport const monthsInQuarter = 3;\n\n/**\n * @constant\n * @name monthsInYear\n * @summary Months in 1 year.\n */\nexport const monthsInYear = 12;\n\n/**\n * @constant\n * @name quartersInYear\n * @summary Quarters in 1 year\n */\nexport const quartersInYear = 4;\n\n/**\n * @constant\n * @name secondsInHour\n * @summary Seconds in 1 hour.\n */\nexport const secondsInHour = 3600;\n\n/**\n * @constant\n * @name secondsInMinute\n * @summary Seconds in 1 minute.\n */\nexport const secondsInMinute = 60;\n\n/**\n * @constant\n * @name secondsInDay\n * @summary Seconds in 1 day.\n */\nexport const secondsInDay = secondsInHour * 24;\n\n/**\n * @constant\n * @name secondsInWeek\n * @summary Seconds in 1 week.\n */\nexport const secondsInWeek = secondsInDay * 7;\n\n/**\n * @constant\n * @name secondsInYear\n * @summary Seconds in 1 year.\n */\nexport const secondsInYear = secondsInDay * daysInYear;\n\n/**\n * @constant\n * @name secondsInMonth\n * @summary Seconds in 1 month\n */\nexport const secondsInMonth = secondsInYear / 12;\n\n/**\n * @constant\n * @name secondsInQuarter\n * @summary Seconds in 1 quarter.\n */\nexport const secondsInQuarter = secondsInMonth * 3;\n\n/**\n * @constant\n * @name constructFromSymbol\n * @summary Symbol enabling Date extensions to inherit properties from the reference date.\n *\n * The symbol is used to enable the `constructFrom` function to construct a date\n * using a reference date and a value. It allows to transfer extra properties\n * from the reference date to the new date. It's useful for extensions like\n * [`TZDate`](https://github.com/date-fns/tz) that accept a time zone as\n * a constructor argument.\n */\nexport const constructFromSymbol = Symbol.for(\"constructDateFrom\");\n","import { constructFromSymbol } from \"./constants.js\";\n\n/**\n * @name constructFrom\n * @category Generic Helpers\n * @summary Constructs a date using the reference date and the value\n *\n * @description\n * The function constructs a new date using the constructor from the reference\n * date and the given value. It helps to build generic functions that accept\n * date extensions.\n *\n * It defaults to `Date` if the passed reference date is a number or a string.\n *\n * Starting from v3.7.0, it allows to construct a date using `[Symbol.for(\"constructDateFrom\")]`\n * enabling to transfer extra properties from the reference date to the new date.\n * It's useful for extensions like [`TZDate`](https://github.com/date-fns/tz)\n * that accept a time zone as a constructor argument.\n *\n * @typeParam DateType - The `Date` type, the function operates on. Gets inferred from passed arguments. Allows to use extensions like [`UTCDate`](https://github.com/date-fns/utc).\n *\n * @param date - The reference date to take constructor from\n * @param value - The value to create the date\n *\n * @returns Date initialized using the given date and value\n *\n * @example\n * import { constructFrom } from \"./constructFrom/date-fns\";\n *\n * // A function that clones a date preserving the original type\n * function cloneDate<DateType extends Date>(date: DateType): DateType {\n *   return constructFrom(\n *     date, // Use constructor from the given date\n *     date.getTime() // Use the date value to create a new date\n *   );\n * }\n */\nexport function constructFrom(date, value) {\n  if (typeof date === \"function\") return date(value);\n\n  if (date && typeof date === \"object\" && constructFromSymbol in date)\n    return date[constructFromSymbol](value);\n\n  if (date instanceof Date) return new date.constructor(value);\n\n  return new Date(value);\n}\n\n// Fallback for modularized imports:\nexport default constructFrom;\n","import { constructFrom } from \"./constructFrom.js\";\n\n/**\n * @name toDate\n * @category Common Helpers\n * @summary Convert the given argument to an instance of Date.\n *\n * @description\n * Convert the given argument to an instance of Date.\n *\n * If the argument is an instance of Date, the function returns its clone.\n *\n * If the argument is a number, it is treated as a timestamp.\n *\n * If the argument is none of the above, the function returns Invalid Date.\n *\n * Starting from v3.7.0, it clones a date using `[Symbol.for(\"constructDateFrom\")]`\n * enabling to transfer extra properties from the reference date to the new date.\n * It's useful for extensions like [`TZDate`](https://github.com/date-fns/tz)\n * that accept a time zone as a constructor argument.\n *\n * **Note**: *all* Date arguments passed to any *date-fns* function is processed by `toDate`.\n *\n * @typeParam DateType - The `Date` type, the function operates on. Gets inferred from passed arguments. Allows to use extensions like [`UTCDate`](https://github.com/date-fns/utc).\n * @typeParam ResultDate - The result `Date` type, it is the type returned from the context function if it is passed, or inferred from the arguments.\n *\n * @param argument - The value to convert\n *\n * @returns The parsed date in the local time zone\n *\n * @example\n * // Clone the date:\n * const result = toDate(new Date(2014, 1, 11, 11, 30, 30))\n * //=> Tue Feb 11 2014 11:30:30\n *\n * @example\n * // Convert the timestamp to date:\n * const result = toDate(1392098430000)\n * //=> Tue Feb 11 2014 11:30:30\n */\nexport function toDate(argument, context) {\n  // [TODO] Get rid of `toDate` or `constructFrom`?\n  return constructFrom(context || argument, argument);\n}\n\n// Fallback for modularized imports:\nexport default toDate;\n","import { constructFrom } from \"./constructFrom.js\";\nimport { toDate } from \"./toDate.js\";\n\n/**\n * The {@link addDays} function options.\n */\n\n/**\n * @name addDays\n * @category Day Helpers\n * @summary Add the specified number of days to the given date.\n *\n * @description\n * Add the specified number of days to the given date.\n *\n * @typeParam DateType - The `Date` type, the function operates on. Gets inferred from passed arguments. Allows to use extensions like [`UTCDate`](https://github.com/date-fns/utc).\n * @typeParam ResultDate - The result `Date` type, it is the type returned from the context function if it is passed, or inferred from the arguments.\n *\n * @param date - The date to be changed\n * @param amount - The amount of days to be added.\n * @param options - An object with options\n *\n * @returns The new date with the days added\n *\n * @example\n * // Add 10 days to 1 September 2014:\n * const result = addDays(new Date(2014, 8, 1), 10)\n * //=> Thu Sep 11 2014 00:00:00\n */\nexport function addDays(date, amount, options) {\n  const _date = toDate(date, options?.in);\n  if (isNaN(amount)) return constructFrom(options?.in || date, NaN);\n\n  // If 0 days, no-op to avoid changing times in the hour before end of DST\n  if (!amount) return _date;\n\n  _date.setDate(_date.getDate() + amount);\n  return _date;\n}\n\n// Fallback for modularized imports:\nexport default addDays;\n","import { addDays } from \"./addDays.js\";\n\n/**\n * The {@link subDays} function options.\n */\n\n/**\n * @name subDays\n * @category Day Helpers\n * @summary Subtract the specified number of days from the given date.\n *\n * @typeParam DateType - The `Date` type, the function operates on. Gets inferred from passed arguments. Allows to use extensions like [`UTCDate`](https://github.com/date-fns/utc).\n * @typeParam ResultDate - The result `Date` type, it is the type returned from the context function if it is passed, or inferred from the arguments.\n *\n * @param date - The date to be changed\n * @param amount - The amount of days to be subtracted.\n * @param options - An object with options\n *\n * @returns The new date with the days subtracted\n *\n * @example\n * // Subtract 10 days from 1 September 2014:\n * const result = subDays(new Date(2014, 8, 1), 10)\n * //=> Fri Aug 22 2014 00:00:00\n */\nexport function subDays(date, amount, options) {\n  return addDays(date, -amount, options);\n}\n\n// Fallback for modularized imports:\nexport default subDays;\n","import { toDate } from \"./toDate.js\";\n\n/**\n * The {@link startOfDay} function options.\n */\n\n/**\n * @name startOfDay\n * @category Day Helpers\n * @summary Return the start of a day for the given date.\n *\n * @description\n * Return the start of a day for the given date.\n * The result will be in the local timezone.\n *\n * @typeParam DateType - The `Date` type, the function operates on. Gets inferred from passed arguments. Allows to use extensions like [`UTCDate`](https://github.com/date-fns/utc).\n * @typeParam ResultDate - The result `Date` type, it is the type returned from the context function if it is passed, or inferred from the arguments.\n *\n * @param date - The original date\n * @param options - The options\n *\n * @returns The start of a day\n *\n * @example\n * // The start of a day for 2 September 2014 11:55:00:\n * const result = startOfDay(new Date(2014, 8, 2, 11, 55, 0))\n * //=> Tue Sep 02 2014 00:00:00\n */\nexport function startOfDay(date, options) {\n  const _date = toDate(date, options?.in);\n  _date.setHours(0, 0, 0, 0);\n  return _date;\n}\n\n// Fallback for modularized imports:\nexport default startOfDay;\n","export function getRoundingMethod(method) {\n  return (number) => {\n    const round = method ? Math[method] : Math.trunc;\n    const result = round(number);\n    // Prevent negative zero\n    return result === 0 ? 0 : result;\n  };\n}\n","import { getRoundingMethod } from \"./_lib/getRoundingMethod.js\";\nimport { millisecondsInMinute } from \"./constants.js\";\nimport { differenceInMilliseconds } from \"./differenceInMilliseconds.js\";\n\n/**\n * The {@link differenceInMinutes} function options.\n */\n\n/**\n * @name differenceInMinutes\n * @category Minute Helpers\n * @summary Get the number of minutes between the given dates.\n *\n * @description\n * Get the signed number of full (rounded towards 0) minutes between the given dates.\n *\n * @param dateLeft - The later date\n * @param dateRight - The earlier date\n * @param options - An object with options.\n *\n * @returns The number of minutes\n *\n * @example\n * // How many minutes are between 2 July 2014 12:07:59 and 2 July 2014 12:20:00?\n * const result = differenceInMinutes(\n *   new Date(2014, 6, 2, 12, 20, 0),\n *   new Date(2014, 6, 2, 12, 7, 59)\n * )\n * //=> 12\n *\n * @example\n * // How many minutes are between 10:01:59 and 10:00:00\n * const result = differenceInMinutes(\n *   new Date(2000, 0, 1, 10, 0, 0),\n *   new Date(2000, 0, 1, 10, 1, 59)\n * )\n * //=> -1\n */\nexport function differenceInMinutes(dateLeft, dateRight, options) {\n  const diff =\n    differenceInMilliseconds(dateLeft, dateRight) / millisecondsInMinute;\n  return getRoundingMethod(options?.roundingMethod)(diff);\n}\n\n// Fallback for modularized imports:\nexport default differenceInMinutes;\n","import { toDate } from \"./toDate.js\";\n\n/**\n * @name differenceInMilliseconds\n * @category Millisecond Helpers\n * @summary Get the number of milliseconds between the given dates.\n *\n * @description\n * Get the number of milliseconds between the given dates.\n *\n * @param laterDate - The later date\n * @param earlierDate - The earlier date\n *\n * @returns The number of milliseconds\n *\n * @example\n * // How many milliseconds are between\n * // 2 July 2014 12:30:20.600 and 2 July 2014 12:30:21.700?\n * const result = differenceInMilliseconds(\n *   new Date(2014, 6, 2, 12, 30, 21, 700),\n *   new Date(2014, 6, 2, 12, 30, 20, 600)\n * )\n * //=> 1100\n */\nexport function differenceInMilliseconds(laterDate, earlierDate) {\n  return +toDate(laterDate) - +toDate(earlierDate);\n}\n\n// Fallback for modularized imports:\nexport default differenceInMilliseconds;\n","import { differenceInMinutes } from 'date-fns';\r\nimport type { MetricSource, Prisma } from '@prisma/client';\r\n\r\nimport { prisma } from '@/lib/prisma';\r\n\r\ninterface CacheParams<T> {\r\n  key: string;\r\n  from: Date;\r\n  to: Date;\r\n  source: MetricSource;\r\n  ttlMinutes?: number;\r\n  fetcher: () => Promise<T>;\r\n}\r\n\r\nlet cacheDisabled = false;\r\n\r\nfunction toJsonValue<T>(value: T): Prisma.InputJsonValue {\r\n  return value as Prisma.InputJsonValue;\r\n}\r\n\r\nexport async function withMetricCache<T>({ key, from, to, source, ttlMinutes = 60, fetcher }: CacheParams<T>): Promise<T> {\r\n  if (cacheDisabled) {\r\n    return fetcher();\r\n  }\r\n\r\n  try {\r\n    const existing = await prisma.cachedMetric.findFirst({\r\n      where: { key },\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n\r\n    if (existing && differenceInMinutes(new Date(), existing.createdAt) < ttlMinutes) {\r\n      return existing.value as T;\r\n    }\r\n\r\n    const value = await fetcher();\r\n    await prisma.cachedMetric\r\n      .create({\r\n        data: {\r\n          key,\r\n          value: toJsonValue(value),\r\n          fromDate: from,\r\n          toDate: to,\r\n          source\r\n        }\r\n      })\r\n      .catch((error) => {\r\n        console.warn('Failed to persist cached metric', error instanceof Error ? error.message : error);\r\n      });\r\n\r\n    return value;\r\n  } catch (error) {\r\n    cacheDisabled = true;\r\n    console.warn('Metric cache unavailable, falling back to live fetch', error instanceof Error ? error.message : error);\r\n    return fetcher();\r\n  }\r\n}\r\n\r\n","\"use server\";\r\n\r\nimport { MetricSource } from \"@prisma/client\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { syncPledgesToDb } from \"@/lib/etapestry\";\r\nimport { syncEventsToDb } from \"@/lib/eventbrite\";\r\nimport { recordIntegrationSync } from \"@/lib/integration-sync\";\r\n\r\nexport async function syncIntegrationsAction() {\r\n  const session = await getServerSession(authOptions);\r\n  if (!session) {\r\n    throw new Error(\"Authentication required\");\r\n  }\r\n  if (session.user.role !== \"ADMIN\") {\r\n    throw new Error(\"Admin access required\");\r\n  }\r\n\r\n  const result: {\r\n    etapestry: { synced: number } | null;\r\n    eventbrite: { synced: number } | null;\r\n  } = {\r\n    etapestry: null,\r\n    eventbrite: null\r\n  };\r\n  const errors: string[] = [];\r\n\r\n  try {\r\n    result.etapestry = await syncPledgesToDb();\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : \"Unknown eTapestry error\";\r\n    errors.push(`eTapestry: ${message}`);\r\n    await recordIntegrationSync(MetricSource.ETAPESTRY, { error: message });\r\n  }\r\n\r\n  try {\r\n    result.eventbrite = await syncEventsToDb();\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : \"Unknown Eventbrite error\";\r\n    errors.push(`Eventbrite: ${message}`);\r\n    await recordIntegrationSync(MetricSource.EVENTBRITE, { error: message });\r\n  }\r\n\r\n  revalidatePath(\"/\");\r\n  revalidatePath(\"/events\");\r\n  revalidatePath(\"/donors\");\r\n\r\n  if (errors.length) {\r\n    return { success: false, errors, result };\r\n  }\r\n\r\n  return { success: true, result };\r\n}\r\n\r\n\r\n"],"names":[],"mappings":"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","ignoreList":[0,1,2,3,5,6,7,8,9,10,11,12,13]}