{"version":3,"sources":["../../../../src/app/%28dashboard%29/settings/actions.ts","../../../../src/lib/secure-settings.ts","../../../../.next-internal/server/app/%28dashboard%29/settings/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["\"use server\";\r\n\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { redirect } from \"next/navigation\";\r\nimport { z } from \"zod\";\r\n\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { upsertSecureSetting } from \"@/lib/secure-settings\";\r\n\r\nconst updateSettingSchema = z.object({\r\n  key: z.string().min(1),\r\n  value: z.string().min(1)\r\n});\r\n\r\nconst updateUserRoleSchema = z.object({\r\n  userId: z.string().cuid(),\r\n  role: z.enum([\"ADMIN\", \"STAFF\"])\r\n});\r\n\r\nasync function requireAdminSession() {\r\n  const session = await getServerSession(authOptions);\r\n  if (!session) {\r\n    redirect(\"/auth/signin\");\r\n  }\r\n  if (session.user.role !== \"ADMIN\") {\r\n    redirect(\"/\");\r\n  }\r\n  return session;\r\n}\r\n\r\nexport async function updateSecureSettingAction(formData: FormData) {\r\n  const session = await requireAdminSession();\r\n  const parsed = updateSettingSchema.safeParse({\r\n    key: formData.get(\"key\"),\r\n    value: formData.get(\"value\")\r\n  });\r\n  if (!parsed.success) {\r\n    throw new Error(\"Invalid setting payload.\");\r\n  }\r\n\r\n  await upsertSecureSetting({\r\n    key: parsed.data.key,\r\n    value: parsed.data.value,\r\n    userId: session.user.id\r\n  });\r\n\r\n  revalidatePath(\"/settings\");\r\n}\r\n\r\nexport async function updateUserRoleAction(formData: FormData) {\r\n  const session = await requireAdminSession();\r\n  const parsed = updateUserRoleSchema.safeParse({\r\n    userId: formData.get(\"userId\"),\r\n    role: formData.get(\"role\")\r\n  });\r\n  if (!parsed.success) {\r\n    throw new Error(\"Invalid user payload.\");\r\n  }\r\n  if (parsed.data.userId === session.user.id && parsed.data.role !== \"ADMIN\") {\r\n    throw new Error(\"You cannot downgrade your own role.\");\r\n  }\r\n\r\n  await prisma.user.update({\r\n    where: { id: parsed.data.userId },\r\n    data: { role: parsed.data.role }\r\n  });\r\n\r\n  revalidatePath(\"/settings\");\r\n}\r\n\r\n\r\n","import crypto from 'crypto';\r\n\r\nimport { prisma } from '@/lib/prisma';\r\nimport { env } from '@/lib/env';\r\n\r\nexport type SettingInputType = 'text' | 'textarea';\r\n\r\nexport interface SettingDefinition {\r\n  key: string;\r\n  label: string;\r\n  description: string;\r\n  type: SettingInputType;\r\n  placeholder?: string;\r\n}\r\n\r\nexport interface SettingWithMeta extends SettingDefinition {\r\n  updatedAt: Date | null;\r\n  updatedBy: string | null;\r\n  hasValue: boolean;\r\n  preview?: string | null;\r\n}\r\n\r\nconst ENCRYPTION_KEY = env.SETTINGS_ENCRYPTION_KEY_BUFFER;\r\nconst ALGO = 'aes-256-gcm';\r\n\r\nfunction encryptValue(value: string) {\r\n  const iv = crypto.randomBytes(12);\r\n  const cipher = crypto.createCipheriv(ALGO, ENCRYPTION_KEY, iv);\r\n  const encrypted = Buffer.concat([cipher.update(value, 'utf8'), cipher.final()]);\r\n  const authTag = cipher.getAuthTag();\r\n  return Buffer.concat([iv, authTag, encrypted]).toString('base64');\r\n}\r\n\r\nfunction decryptValue(payload: string) {\r\n  const buffer = Buffer.from(payload, 'base64');\r\n  const iv = buffer.subarray(0, 12);\r\n  const authTag = buffer.subarray(12, 28);\r\n  const encrypted = buffer.subarray(28);\r\n  const decipher = crypto.createDecipheriv(ALGO, ENCRYPTION_KEY, iv);\r\n  decipher.setAuthTag(authTag);\r\n  const decrypted = Buffer.concat([decipher.update(encrypted), decipher.final()]);\r\n  return decrypted.toString('utf8');\r\n}\r\n\r\nexport const INTEGRATION_SETTING_DEFINITIONS: SettingDefinition[] = [\r\n  {\r\n    key: 'EVENTBRITE_API_TOKEN',\r\n    label: 'Eventbrite API Token',\r\n    description: 'Personal OAuth token used for syncing events.',\r\n    type: 'text'\r\n  },\r\n  {\r\n    key: 'EVENTBRITE_ORGANIZATION_ID',\r\n    label: 'Eventbrite Organization ID',\r\n    description: 'Organization identifier for event syncs.',\r\n    type: 'text'\r\n  },\r\n  {\r\n    key: 'ETAPESTRY_API_KEY',\r\n    label: 'eTapestry API Key',\r\n    description: 'API key for SOAP integration.',\r\n    type: 'text'\r\n  },\r\n  {\r\n    key: 'ETAPESTRY_LOGIN_ID',\r\n    label: 'eTapestry Login ID',\r\n    description: 'Username used with the API key.',\r\n    type: 'text'\r\n  },\r\n  {\r\n    key: 'ETAPESTRY_LOGIN_PASSWORD',\r\n    label: 'eTapestry Login Password',\r\n    description: 'Password paired with the login ID.',\r\n    type: 'text'\r\n  },\r\n  {\r\n    key: 'GA4_SERVICE_ACCOUNT_JSON',\r\n    label: 'GA4 Service Account JSON',\r\n    description: 'Full JSON credentials for the GA4 Data API.',\r\n    type: 'textarea',\r\n    placeholder: '{ \"type\": \"service_account\", ... }'\r\n  },\r\n  {\r\n    key: 'GEMINI_API_KEY',\r\n    label: 'Gemini API Key',\r\n    description: 'Used for AI drafting.',\r\n    type: 'text'\r\n  }\r\n];\r\n\r\nexport async function listSecureSettings(): Promise<SettingWithMeta[]> {\r\n  const keys = INTEGRATION_SETTING_DEFINITIONS.map((definition) => definition.key);\r\n  const entries = await prisma.secureSetting.findMany({\r\n    where: { key: { in: keys } },\r\n    include: { updatedBy: true }\r\n  });\r\n  const map = new Map(entries.map((entry) => [entry.key, entry]));\r\n\r\n  return INTEGRATION_SETTING_DEFINITIONS.map((definition) => {\r\n    const row = map.get(definition.key);\r\n    let preview: string | null = null;\r\n    if (row) {\r\n      try {\r\n        const value = decryptValue(row.encryptedValue);\r\n        preview =\r\n          value.length > 8 ? `•••• ${value.slice(-4)}` : '••••';\r\n      } catch {\r\n        preview = 'Unable to decrypt';\r\n      }\r\n    }\r\n    return {\r\n      ...definition,\r\n      updatedAt: row?.updatedAt ?? null,\r\n      updatedBy: row?.updatedBy?.email ?? row?.updatedBy?.name ?? null,\r\n      hasValue: Boolean(row),\r\n      preview\r\n    };\r\n  });\r\n}\r\n\r\nexport async function upsertSecureSetting(params: { key: string; value: string; userId?: string }) {\r\n  const definition = INTEGRATION_SETTING_DEFINITIONS.find((item) => item.key === params.key);\r\n  if (!definition) {\r\n    throw new Error(`Unknown setting ${params.key}`);\r\n  }\r\n  const encryptedValue = encryptValue(params.value);\r\n  const existing = await prisma.secureSetting.upsert({\r\n    where: { key: params.key },\r\n    update: {\r\n      encryptedValue,\r\n      updatedById: params.userId ?? null\r\n    },\r\n    create: {\r\n      key: params.key,\r\n      encryptedValue,\r\n      updatedById: params.userId ?? null\r\n    }\r\n  });\r\n\r\n  await prisma.secureSettingHistory.create({\r\n    data: {\r\n      key: params.key,\r\n      encryptedValue,\r\n      settingId: existing.id,\r\n      updatedById: params.userId ?? null\r\n    }\r\n  });\r\n}\r\n\r\nexport async function getSecureSettingValue(key: string) {\r\n  const row = await prisma.secureSetting.findUnique({ where: { key } });\r\n  if (!row) return null;\r\n  try {\r\n    return decryptValue(row.encryptedValue);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\n\r\n","export {updateSecureSettingAction as '40528bc0fff7d1ed92663858d39c9bea6e2044ac3d'} from 'ACTIONS_MODULE0'\nexport {updateUserRoleAction as '40a6b5841ea69c11e128d9d7c2b7503f5bfac58021'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":"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"}