module.exports=[37936,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"registerServerReference",{enumerable:!0,get:function(){return d.registerServerReference}});let d=a.r(11857)},13095,(a,b,c)=>{"use strict";function d(a){for(let b=0;b<a.length;b++){let c=a[b];if("function"!=typeof c)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof c}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"ensureServerEntryExports",{enumerable:!0,get:function(){return d}})},76340,a=>{"use strict";var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t=a.i(37936),u=a.i(29173),v=a.i(20971),w=a.i(53112),x=a.i(9307);let y=["user","model","function","system"];(b=k||(k={})).HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",b.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",b.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",b.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",b.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",(c=l||(l={})).HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",c.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",c.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",c.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",c.BLOCK_NONE="BLOCK_NONE",(d=m||(m={})).HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",d.NEGLIGIBLE="NEGLIGIBLE",d.LOW="LOW",d.MEDIUM="MEDIUM",d.HIGH="HIGH",(e=n||(n={})).BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",e.SAFETY="SAFETY",e.OTHER="OTHER",(f=o||(o={})).FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",f.STOP="STOP",f.MAX_TOKENS="MAX_TOKENS",f.SAFETY="SAFETY",f.RECITATION="RECITATION",f.OTHER="OTHER",(g=p||(p={})).TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",g.RETRIEVAL_QUERY="RETRIEVAL_QUERY",g.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",g.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",g.CLASSIFICATION="CLASSIFICATION",g.CLUSTERING="CLUSTERING",(h=q||(q={})).MODE_UNSPECIFIED="MODE_UNSPECIFIED",h.AUTO="AUTO",h.ANY="ANY",h.NONE="NONE",(i=r||(r={})).STRING="STRING",i.NUMBER="NUMBER",i.INTEGER="INTEGER",i.BOOLEAN="BOOLEAN",i.ARRAY="ARRAY",i.OBJECT="OBJECT";class z extends Error{constructor(a){super(`[GoogleGenerativeAI Error]: ${a}`)}}class A extends z{constructor(a,b){super(a),this.response=b}}class B extends z{constructor(a,b,c,d){super(a),this.status=b,this.statusText=c,this.errorDetails=d}}class C extends z{}(j=s||(s={})).GENERATE_CONTENT="generateContent",j.STREAM_GENERATE_CONTENT="streamGenerateContent",j.COUNT_TOKENS="countTokens",j.EMBED_CONTENT="embedContent",j.BATCH_EMBED_CONTENTS="batchEmbedContents";class D{constructor(a,b,c,d,e){this.model=a,this.task=b,this.apiKey=c,this.stream=d,this.requestOptions=e}toString(){var a,b;let c=(null==(a=this.requestOptions)?void 0:a.apiVersion)||"v1beta",d=(null==(b=this.requestOptions)?void 0:b.baseUrl)||"https://generativelanguage.googleapis.com",e=`${d}/${c}/${this.model}:${this.task}`;return this.stream&&(e+="?alt=sse"),e}}async function E(a){var b;let c,d=new Headers;d.append("Content-Type","application/json"),d.append("x-goog-api-client",(b=a.requestOptions,c=[],(null==b?void 0:b.apiClient)&&c.push(b.apiClient),c.push("genai-js/0.11.5"),c.join(" "))),d.append("x-goog-api-key",a.apiKey);let e=a.requestOptions.customHeaders;if(e){if(!(e instanceof Headers))try{e=new Headers(e)}catch(a){throw new C(`unable to convert customHeaders value ${JSON.stringify(e)} to Headers: ${a.message}`)}for(let[a,b]of e.entries()){if("x-goog-api-key"===a)throw new C(`Cannot set reserved header name ${a}`);if("x-goog-api-client"===a)throw new C(`Header name ${a} can only be set using the apiClient field`);d.append(a,b)}}return d}async function F(a,b,c,d,e,f){let g=new D(a,b,c,d,f);return{url:g.toString(),fetchOptions:Object.assign(Object.assign({},function(a){let b={};if((null==a?void 0:a.timeout)>=0){let c=new AbortController,d=c.signal;setTimeout(()=>c.abort(),a.timeout),b.signal=d}return b}(f)),{method:"POST",headers:await E(g),body:e})}}async function G(a,b,c,d,e,f){return H(a,b,c,d,e,f,fetch)}async function H(a,b,c,d,e,f,g=fetch){let h,i=new D(a,b,c,d,f);try{let j=await F(a,b,c,d,e,f);if(!(h=await g(j.url,j.fetchOptions)).ok){let a,b="";try{let c=await h.json();b=c.error.message,c.error.details&&(b+=` ${JSON.stringify(c.error.details)}`,a=c.error.details)}catch(a){}throw new B(`Error fetching from ${i.toString()}: [${h.status} ${h.statusText}] ${b}`,h.status,h.statusText,a)}}catch(b){let a=b;throw b instanceof B||b instanceof C||((a=new z(`Error fetching from ${i.toString()}: ${b.message}`)).stack=b.stack),a}return h}function I(a){return a.text=()=>{if(a.candidates&&a.candidates.length>0){if(a.candidates.length>1&&console.warn(`This response had ${a.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),L(a.candidates[0]))throw new A(`${M(a)}`,a);return function(a){var b,c,d,e;let f=[];if(null==(c=null==(b=a.candidates)?void 0:b[0].content)?void 0:c.parts)for(let b of null==(e=null==(d=a.candidates)?void 0:d[0].content)?void 0:e.parts)b.text&&f.push(b.text);return f.length>0?f.join(""):""}(a)}if(a.promptFeedback)throw new A(`Text not available. ${M(a)}`,a);return""},a.functionCall=()=>{if(a.candidates&&a.candidates.length>0){if(a.candidates.length>1&&console.warn(`This response had ${a.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),L(a.candidates[0]))throw new A(`${M(a)}`,a);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),J(a)[0]}if(a.promptFeedback)throw new A(`Function call not available. ${M(a)}`,a)},a.functionCalls=()=>{if(a.candidates&&a.candidates.length>0){if(a.candidates.length>1&&console.warn(`This response had ${a.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),L(a.candidates[0]))throw new A(`${M(a)}`,a);return J(a)}if(a.promptFeedback)throw new A(`Function call not available. ${M(a)}`,a)},a}function J(a){var b,c,d,e;let f=[];if(null==(c=null==(b=a.candidates)?void 0:b[0].content)?void 0:c.parts)for(let b of null==(e=null==(d=a.candidates)?void 0:d[0].content)?void 0:e.parts)b.functionCall&&f.push(b.functionCall);return f.length>0?f:void 0}let K=[o.RECITATION,o.SAFETY];function L(a){return!!a.finishReason&&K.includes(a.finishReason)}function M(a){var b,c,d;let e="";if((!a.candidates||0===a.candidates.length)&&a.promptFeedback)e+="Response was blocked",(null==(b=a.promptFeedback)?void 0:b.blockReason)&&(e+=` due to ${a.promptFeedback.blockReason}`),(null==(c=a.promptFeedback)?void 0:c.blockReasonMessage)&&(e+=`: ${a.promptFeedback.blockReasonMessage}`);else if(null==(d=a.candidates)?void 0:d[0]){let b=a.candidates[0];L(b)&&(e+=`Candidate was blocked due to ${b.finishReason}`,b.finishMessage&&(e+=`: ${b.finishMessage}`))}return e}function N(a){return this instanceof N?(this.v=a,this):new N(a)}"function"==typeof SuppressedError&&SuppressedError;let O=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;async function P(a){let b=[],c=a.getReader();for(;;){let{done:a,value:d}=await c.read();if(a)return I(function(a){let b=a[a.length-1],c={promptFeedback:null==b?void 0:b.promptFeedback};for(let b of a)if(b.candidates)for(let a of b.candidates){let b=a.index;if(c.candidates||(c.candidates=[]),c.candidates[b]||(c.candidates[b]={index:a.index}),c.candidates[b].citationMetadata=a.citationMetadata,c.candidates[b].finishReason=a.finishReason,c.candidates[b].finishMessage=a.finishMessage,c.candidates[b].safetyRatings=a.safetyRatings,a.content&&a.content.parts){c.candidates[b].content||(c.candidates[b].content={role:a.content.role||"user",parts:[]});let d={};for(let e of a.content.parts)e.text&&(d.text=e.text),e.functionCall&&(d.functionCall=e.functionCall),0===Object.keys(d).length&&(d.text=""),c.candidates[b].content.parts.push(d)}}return c}(b));b.push(d)}}async function Q(a,b,c,d){return function(a){let b,[c,d]=(b=a.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})).getReader(),new ReadableStream({start(a){let c="";return function d(){return b.read().then(({value:b,done:e})=>{let f;if(e)return c.trim()?void a.error(new z("Failed to parse stream")):void a.close();let g=(c+=b).match(O);for(;g;){try{f=JSON.parse(g[1])}catch(b){a.error(new z(`Error parsing JSON response: "${g[1]}"`));return}a.enqueue(f),g=(c=c.substring(g[0].length)).match(O)}return d()})}()}})).tee();return{stream:function(a){return function(a,b,c){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var d,e=c.apply(a,b||[]),f=[];return d={},g("next"),g("throw"),g("return"),d[Symbol.asyncIterator]=function(){return this},d;function g(a){e[a]&&(d[a]=function(b){return new Promise(function(c,d){f.push([a,b,c,d])>1||h(a,b)})})}function h(a,b){try{var c;(c=e[a](b)).value instanceof N?Promise.resolve(c.value.v).then(i,j):k(f[0][2],c)}catch(a){k(f[0][3],a)}}function i(a){h("next",a)}function j(a){h("throw",a)}function k(a,b){a(b),f.shift(),f.length&&h(f[0][0],f[0][1])}}(this,arguments,function*(){let b=a.getReader();for(;;){let{value:a,done:c}=yield N(b.read());if(c)break;yield yield N(I(a))}})}(c),response:P(d)}}(await G(b,s.STREAM_GENERATE_CONTENT,a,!0,JSON.stringify(c),d))}async function R(a,b,c,d){let e=await G(b,s.GENERATE_CONTENT,a,!1,JSON.stringify(c),d);return{response:I(await e.json())}}function S(a){if(null!=a){if("string"==typeof a)return{role:"system",parts:[{text:a}]};if(a.text)return{role:"system",parts:[a]};if(a.parts)if(!a.role)return{role:"system",parts:a.parts};else return a}}function T(a){let b=[];if("string"==typeof a)b=[{text:a}];else for(let c of a)"string"==typeof c?b.push({text:c}):b.push(c);var c=b;let d={role:"user",parts:[]},e={role:"function",parts:[]},f=!1,g=!1;for(let a of c)"functionResponse"in a?(e.parts.push(a),g=!0):(d.parts.push(a),f=!0);if(f&&g)throw new z("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!f&&!g)throw new z("No content is provided for sending chat message.");return f?d:e}function U(a){let b;return b=a.contents?a:{contents:[T(a)]},a.systemInstruction&&(b.systemInstruction=S(a.systemInstruction)),b}let V=["text","inlineData","functionCall","functionResponse"],W={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall"],system:["text"]},X="SILENT_ERROR";class Y{constructor(a,b,c,d){this.model=b,this.params=c,this.requestOptions=d,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=a,(null==c?void 0:c.history)&&(!function(a){let b=!1;for(let c of a){let{role:a,parts:d}=c;if(!b&&"user"!==a)throw new z(`First content should be with role 'user', got ${a}`);if(!y.includes(a))throw new z(`Each item should include role field. Got ${a} but valid roles are: ${JSON.stringify(y)}`);if(!Array.isArray(d))throw new z("Content should have 'parts' property with an array of Parts");if(0===d.length)throw new z("Each Content should have at least one part");let e={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0};for(let a of d)for(let b of V)b in a&&(e[b]+=1);let f=W[a];for(let b of V)if(!f.includes(b)&&e[b]>0)throw new z(`Content with role '${a}' can't contain '${b}' part`);b=!0}}(c.history),this._history=c.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(a){var b,c,d,e,f;let g;await this._sendPromise;let h=T(a),i={safetySettings:null==(b=this.params)?void 0:b.safetySettings,generationConfig:null==(c=this.params)?void 0:c.generationConfig,tools:null==(d=this.params)?void 0:d.tools,toolConfig:null==(e=this.params)?void 0:e.toolConfig,systemInstruction:null==(f=this.params)?void 0:f.systemInstruction,contents:[...this._history,h]};return this._sendPromise=this._sendPromise.then(()=>R(this._apiKey,this.model,i,this.requestOptions)).then(a=>{var b;if(a.response.candidates&&a.response.candidates.length>0){this._history.push(h);let c=Object.assign({parts:[],role:"model"},null==(b=a.response.candidates)?void 0:b[0].content);this._history.push(c)}else{let b=M(a.response);b&&console.warn(`sendMessage() was unsuccessful. ${b}. Inspect response object for details.`)}g=a}),await this._sendPromise,g}async sendMessageStream(a){var b,c,d,e,f;await this._sendPromise;let g=T(a),h={safetySettings:null==(b=this.params)?void 0:b.safetySettings,generationConfig:null==(c=this.params)?void 0:c.generationConfig,tools:null==(d=this.params)?void 0:d.tools,toolConfig:null==(e=this.params)?void 0:e.toolConfig,systemInstruction:null==(f=this.params)?void 0:f.systemInstruction,contents:[...this._history,g]},i=Q(this._apiKey,this.model,h,this.requestOptions);return this._sendPromise=this._sendPromise.then(()=>i).catch(a=>{throw Error(X)}).then(a=>a.response).then(a=>{if(a.candidates&&a.candidates.length>0){this._history.push(g);let b=Object.assign({},a.candidates[0].content);b.role||(b.role="model"),this._history.push(b)}else{let b=M(a);b&&console.warn(`sendMessageStream() was unsuccessful. ${b}. Inspect response object for details.`)}}).catch(a=>{a.message!==X&&console.error(a)}),i}}async function Z(a,b,c,d){return(await G(b,s.COUNT_TOKENS,a,!1,JSON.stringify(Object.assign(Object.assign({},c),{model:b})),d)).json()}async function $(a,b,c,d){return(await G(b,s.EMBED_CONTENT,a,!1,JSON.stringify(c),d)).json()}async function _(a,b,c,d){let e=c.requests.map(a=>Object.assign(Object.assign({},a),{model:b}));return(await G(b,s.BATCH_EMBED_CONTENTS,a,!1,JSON.stringify({requests:e}),d)).json()}class aa{constructor(a,b,c){this.apiKey=a,b.model.includes("/")?this.model=b.model:this.model=`models/${b.model}`,this.generationConfig=b.generationConfig||{},this.safetySettings=b.safetySettings||[],this.tools=b.tools,this.toolConfig=b.toolConfig,this.systemInstruction=S(b.systemInstruction),this.requestOptions=c||{}}async generateContent(a){let b=U(a);return R(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},b),this.requestOptions)}async generateContentStream(a){let b=U(a);return Q(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},b),this.requestOptions)}startChat(a){return new Y(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},a),this.requestOptions)}async countTokens(a){let b=U(a);return Z(this.apiKey,this.model,b,this.requestOptions)}async embedContent(a){let b="string"==typeof a||Array.isArray(a)?{content:T(a)}:a;return $(this.apiKey,this.model,b,this.requestOptions)}async batchEmbedContents(a){return _(this.apiKey,this.model,a,this.requestOptions)}}var ab=a.i(31290),ac=a.i(92665),ad=a.i(66518);let ae=new class{constructor(a){this.apiKey=a}getGenerativeModel(a,b){if(!a.model)throw new z("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new aa(this.apiKey,a,b)}}(ac.env.GEMINI_API_KEY).getGenerativeModel({model:ac.env.GEMINI_MODEL});function af(a,b){return a?a.replace(/{{\s*name\s*}}/gi,b??"BHIC supporter"):a}async function ag(a){let b={email:{not:null}};return a.totalGivenGreaterThan&&(b.totalGiven={gte:a.totalGivenGreaterThan}),a.donatedWithinDays&&(b.lastGiftDate={gte:(0,ab.subDays)(new Date,a.donatedWithinDays)}),a.attendedEventIds?.length&&(b.attendance={some:{eventId:{in:a.attendedEventIds}}}),a.pledgeCampaigns?.length&&(b.pledges={some:{campaign:{in:a.pledgeCampaigns}}}),(await ad.prisma.donor.findMany({where:b,select:{id:!0,name:!0,email:!0,totalGiven:!0,lastGiftDate:!0}})).filter(a=>a.email)}async function ah(a){var b,c;let d=await ad.prisma.emailCampaign.findUnique({where:{id:a},include:{template:!0,audienceSegment:!0}});if(!d)throw Error("Campaign not found");let e=d.audienceSegment.filters??{},f=(await ag(e)).slice(0,5).map(a=>({name:a.name??a.email,email:a.email,totalGiven:Number(a.totalGiven??0).toFixed(0),lastGiftDate:a.lastGiftDate?.toISOString()??"Unknown"})),g=f.length>0?f.map(a=>`${a.name} (${a.email}) â€“ lifetime $${a.totalGiven} \xb7 last gift ${a.lastGiftDate.slice(0,10)}`).join("; "):"No matching donors found yet. Suggest a general-purpose draft.";try{let a=(b={campaignName:d.name,templateSubject:d.template.subject,templateHtml:d.template.html,templateText:d.template.text,donorSummary:g},`
You are an assistant helping the Bald Head Island Conservancy craft donor outreach emails.
Write with a warm, professional tone that reflects a conservation nonprofit.

Return ONLY valid JSON with the following shape:
{
  "subject": string,
  "html": string,
  "text": string,
  "talkingPoints": string[]
}

Guidance:
- Keep the subject under 80 characters.
- Provide a short HTML body (2-4 paragraphs max) with basic formatting (p, strong, ul/li).
- Provide a text-only alternative that mirrors the HTML content.
- talkingPoints should be a short array summarizing the main ideas.

Context:
- Campaign: ${b.campaignName}
- Existing subject: ${b.templateSubject}
- Existing HTML (converted to text): ${b.templateHtml.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim().slice(0,1200)}
- Existing text: ${b.templateText.slice(0,1200)}
- Donor insights: ${b.donorSummary}
- Goals or notes: ${b.goals??"Highlight impact, gratitude, and a clear call to action."}
`),c=await ae.generateContent(a),e=function(a){if(!a)throw Error("Gemini did not return any text.");let b=a.match(/```json([\s\S]*?)```/i),c=b?b[1].trim():a.trim(),d=c.indexOf("{"),e=c.lastIndexOf("}");return JSON.parse(-1!==d&&-1!==e?c.slice(d,e+1):c)}(c.response?.text());return{subject:e.subject??d.template.subject,html:e.html??d.template.html,text:e.text??d.template.text,talkingPoints:e.talkingPoints??[],sampleRecipients:f.map(a=>a.email)}}catch(e){let a;console.error("Gemini draft generation failed",e);let b=f[0]?.name;return c=d.template,a=af(c.html,b),{subject:af(c.subject,b),html:a,text:af(c.text,b),talkingPoints:["Automated fallback using saved template"],sampleRecipients:b?[b]:[]}}}var ai=a.i(13095);let aj=w.z.object({name:w.z.string().min(3),audience:w.z.object({donatedWithinDays:w.z.number().optional(),totalGivenGreaterThan:w.z.number().optional(),attendedEventIds:w.z.array(w.z.string()).optional(),pledgeCampaigns:w.z.array(w.z.string()).optional()}),template:w.z.discriminatedUnion("mode",[w.z.object({mode:w.z.literal("existing"),templateId:w.z.string().min(1)}),w.z.object({mode:w.z.literal("new"),name:w.z.string().min(3),subject:w.z.string().min(3),html:w.z.string().min(10),text:w.z.string().min(10)})])});async function ak(){let a=await (0,v.getServerSession)(x.authOptions);if(!a)throw Error("Authentication required");return a}async function al(a){let b;await ak();let c=aj.parse(a),d={donatedWithinDays:c.audience.donatedWithinDays,totalGivenGreaterThan:c.audience.totalGivenGreaterThan,attendedEventIds:c.audience.attendedEventIds?.filter(Boolean),pledgeCampaigns:c.audience.pledgeCampaigns?.filter(Boolean)},e=await ad.prisma.audienceSegment.create({data:{name:`${c.name} audience ${Date.now()}`,filters:d}});return b="existing"===c.template.mode?c.template.templateId:(await ad.prisma.emailTemplate.create({data:{name:c.template.name,subject:c.template.subject,html:c.template.html,text:c.template.text}})).id,{success:!0,campaignId:(await ad.prisma.emailCampaign.create({data:{name:c.name,templateId:b,audienceSegmentId:e.id,status:u.CampaignStatus.DRAFT,scheduledFor:null}})).id}}async function am(a){return await ak(),{success:!0,suggestion:await ah(a)}}(0,ai.ensureServerEntryExports)([al,am]),(0,t.registerServerReference)(al,"4077aea07091fb9867f3992b90de83470c7b78c8ae",null),(0,t.registerServerReference)(am,"40f9d051ee1ba85e7b1176fcb29548a48a6e690027",null),a.s(["createCampaignAction",()=>al,"generateCampaignDraftAction",()=>am],76340)}];

//# sourceMappingURL=_10bd9f16._.js.map